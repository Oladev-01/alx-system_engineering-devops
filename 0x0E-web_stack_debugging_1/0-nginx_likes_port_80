#!/bin/bash

# Update package lists
apt-get update

# Install Nginx
apt-get install -y nginx

# Ensure Nginx service is enabled and started
systemctl enable nginx
systemctl start nginx

# Check if Nginx is listening on port 80
if ! netstat -tuln | grep -q ':80'; then
    echo "Nginx is not listening on port 80. Checking configuration..."
    
    # Check and fix common issues
    # Ensure default server block is enabled and listening on port 80
    if ! grep -q 'listen 80;' /etc/nginx/sites-enabled/default; then
        echo "Adding listen directive to default server block"
        sed -i '/server {/a \\tlisten 80;' /etc/nginx/sites-enabled/default
    fi

    # Reload Nginx to apply changes
    systemctl reload nginx
fi

# Check firewall settings
if command -v ufw >/dev/null 2>&1; then
    echo "Checking firewall settings..."
    ufw allow 'Nginx HTTP'
    ufw reload
fi

exit 0
